<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPEC Petroleum Production 2014 - 2024</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
        }
        .title {
            text-align: center;
            font-family: 'Gotham', 'Arial', sans-serif;
            font-size: 71px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #585858;
            text-transform: uppercase;
            letter-spacing: 3px;
            transform: translate(12px, -10px);
        }
        .subtitle {
            text-align: center;
            font-size: 14px;
            color: #999;
            font-weight: bold;
            margin-bottom: -40px;
            transform: translate(11px, -10px);
            
        }
        .ridgeline-container {
            margin: 20px 0;
            text-align: center;
        }
        #ridgeline-plot {
            display: block;
            margin: 0 auto;
        }
        .country-label {
            font-family: 'Gotham', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: bold;
            fill: #747474;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .country-label-strikethrough {
            font-family: 'Gotham', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: bold;
            fill: #999;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-decoration: line-through;
        }
        .axis-label {
            font-size: 11px;
            fill: #666;
        }
        .ridge {
            fill: #019cde;
            fill-opacity: 0.7;
        }
        .ridge:hover {
            fill-opacity: 0.9;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
        }
        .legend {
            margin-top: 20px;
            font-size: 12px;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
        }
        .membership-info {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 12px;
            line-height: 1.4;
        }
        .membership-category {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        .timeline {
            position: relative;
            margin: 30px 20px;
            height: 120px;
        }
        .timeline-line {
            position: absolute;
            top: 30px;
            left: 0;
            right: 0;
            height: 1px;
            background: #ccc;
        }
        .tenure-bar {
            position: absolute;
            height: 8px;
            background: #019cde;
            border-radius: 4px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .tenure-bar:hover {
            opacity: 1;
        }
        .tenure-label {
            position: absolute;
            font-size: 9px;
            color: #666;
            white-space: nowrap;
            font-weight: bold;
        }
        .timeline-flag {
            position: absolute;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
            top: 25px;
            transform: translateY(-50%);
            z-index: 10;
        }
        .timeline-flag:hover {
            transform: translateY(-50%) scale(1.3);
        }
        .flag-tooltip {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 15;
        }
        .timeline-flag:hover .flag-tooltip {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">
            <span style="color: #019cde;">OPEC</span><span style="color: #2c3e50;">'s Production</span>
        </div>
        <div class="subtitle">Production trajectories by country between 2014 to 2024, normalized within its specific range. <span style="color: #019cde;">Ridge Height = Relative Change</span><span style="color: #2c3e50;"></span>
</div>
        
        <div class="ridgeline-container">
            <svg id="ridgeline-plot"></svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div style="text-align: center;">
                    <span style="color: #999; font-family: 'Gotham', 'Arial', sans-serif; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 11px;">CURRENT MEMBER</span>
                </div>
            </div>
            <div class="legend-item">
                <div style="text-align: center;">
                    <span style="color: #999; font-family: 'Gotham', 'Arial', sans-serif; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 11px; text-decoration: line-through;">FORMER MEMBER</span>
                </div>
            </div>
            <div style="text-align: center; width: 100%; margin-top: 1px;">
                <span style="color: #666; font-size: 10px; font-style: italic;">*As of 2025</span>
            </div>
        </div>
        
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Data from the CSV (cleaned and processed)
        const rawCountries = [
            {name: "Algeria", values: [1192.8, 1157.1, 1146.3, 1058.7, 1040.1, 1023, 899, 911, 1020, 973, 907], membershipType: "always"},
            {name: "Angola", values: [1653.7, 1767.1, 1721.6, 1632.2, 1473.3, 1373, 1271, 1124, 1137, 1098, 1125], membershipType: "leftDuring"},
            {name: "Congo", values: [null, null, null, 262.7, 323.5, 329, 300, 267, 262, 271, 260], membershipType: "joinedDuring"},
            {name: "Ecuador", values: [556.6, 543.1, 549.0, 531.3, 517.2, 531, 479, 473, 481, 475, 475], membershipType: "leftDuring"},
            {name: "Equatorial Guinea", values: [null, null, 160.1, 128.6, 120.2, 110, 114, 93, 81, 55, 57], membershipType: "joinedDuring"},
            {name: "Gabon", values: [null, 213.5, 220.7, 210.1, 193.4, 218, 207, 181, 191, 223, 224], membershipType: "joinedDuring"},
            {name: "Indonesia", values: [697.3, 690.1, 737.9, 710.2, 684.4, 664, 631, 585, 539, 540, 517], membershipType: "notMember"},
            {name: "Iraq", values: [3110.5, 3504.1, 4647.8, 4468.7, 4410.0, 4576, 3997, 3971, 4453, 4118, 3862], membershipType: "always"},
            {name: "Kuwait", values: [2950, 2866.8, 2858.7, 2954.3, 2704.2, 2750, 2678, 2438, 2415, 2707, 2411], membershipType: "always"},
            {name: "Libya", values: [479.9, 403.7, 389.1, 810.5, 951.2, 1091, 389, 1207, 981, 1189, 1136], membershipType: "always"},
            {name: "Nigeria", values: [1807.0, 1748.2, 1427.3, 1535.6, 1601.6, 1737, 1493, 1323, 1138, 1187, 1345], membershipType: "always"},
            {name: "Qatar", values: [709.2, 656.0, 651.5, 600.0, 600.6, 595, 603, 601, 606, 606, 614], membershipType: "leftDuring"},
            {name: "Saudi Arabia", values: [9800, 9712.7, 10192.6, 10460.2, 9959.2, 9850, 9808, 9213, 9125, 10591, 8955], membershipType: "always"},
            {name: "United Arab Emirates", values: [2794.0, 2988.9, 3088.3, 2966.5, 3008.3, 3058, 2779, 2718, 3064, 2944, 2916], membershipType: "always"},
            {name: "Venezuela", values: [2682.6, 2653.9, 2372.5, 2034.8, 1510.2, 1013, 569, 636, 716, 783, 921], membershipType: "always"}
        ];

        // Calculate trend for each country and sort by trend
        const countries = rawCountries.map(country => {
            const validValues = country.values.filter(v => v !== null);
            if (validValues.length < 2) {
                return {...country, trend: 0, trendPercent: 0};
            }
            const firstValue = validValues[0];
            const lastValue = validValues[validValues.length - 1];
            const trend = lastValue - firstValue;
            const trendPercent = (trend / firstValue) * 100;
            return {...country, trend, trendPercent};
        }).sort((a, b) => b.trendPercent - a.trendPercent); // Sort by trend percentage (decreasing order)

        const years = [2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024];

        // Set up dimensions
        const margin = {top: 40, right: 60, bottom: 80, left: 100};
        const width = 1000 - margin.left - margin.right;
        const height = 1820 - margin.bottom - margin.top; // Reduced height since ridges are closer together
        const ridgeHeight = 200; // Increased from 120 to 200
        const ridgeSpacing = 120; // Reduced from 220 to 160 for slight overlap

        const svg = d3.select("#ridgeline-plot")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.bottom + margin.top);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Color scale for membership types - all OPEC blue
        const opecBlue = "#019cde"; // OPEC official blue
        const colorScale = d3.scaleOrdinal()
            .domain(["always", "leftDuring", "joinedDuring", "notMember"])
            .range([opecBlue, opecBlue, opecBlue, opecBlue]);

        // Create gradient definitions for fade in/out effects
        const defs = svg.append("defs");
        
        // Create a gradient for each country
        countries.forEach((countryData, i) => {
            const gradient = defs.append("linearGradient")
                .attr("id", `fade-gradient-${i}`)
                .attr("x1", "0%")
                .attr("x2", "100%")
                .attr("y1", "0%")
                .attr("y2", "0%");
            
            // Add gradient stops for fade in/out
            gradient.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", colorScale(countryData.membershipType))
                .attr("stop-opacity", "0"); // Fade in from transparent
            
            gradient.append("stop")
                .attr("offset", "15%")
                .attr("stop-color", colorScale(countryData.membershipType))
                .attr("stop-opacity", "0.7"); // Full opacity
            
            gradient.append("stop")
                .attr("offset", "85%")
                .attr("stop-color", colorScale(countryData.membershipType))
                .attr("stop-opacity", "0.7"); // Full opacity
            
            gradient.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", colorScale(countryData.membershipType))
                .attr("stop-opacity", "0"); // Fade out to transparent
        });

        // X scale for years
        const xScale = d3.scaleLinear()
            .domain([2014, 2024])
            .range([0, width]);

        // Y position scale for countries
        const yScale = d3.scalePoint()
            .domain(countries.map(d => d.name))
            .range([ridgeHeight, countries.length * ridgeSpacing]) // Start from ridgeHeight instead of 0
            .padding(0.2); // Increased padding

        // Production scale for ridge heights - using log scale for better visualization
        const minProduction = d3.min(countries.flatMap(d => d.values.filter(v => v !== null)));
        const maxProduction = d3.max(countries.flatMap(d => d.values.filter(v => v !== null)));
        
        // Use square root scale to exaggerate differences
        const productionScale = d3.scalePow()
            .exponent(0.7) // Makes smaller values more prominent
            .domain([0, maxProduction])
            .range([0, ridgeHeight]);

        // Create ridgelines for each country
        countries.forEach((countryData, i) => {
            const validData = [];
            countryData.values.forEach((value, yearIndex) => {
                if (value !== null) {
                    validData.push({
                        year: years[yearIndex],
                        production: value
                    });
                }
            });

            if (validData.length === 0) return;

            // Use relative scaling within each country for maximum fluctuation visibility
            const countryMin = d3.min(validData, d => d.production);
            const countryMax = d3.max(validData, d => d.production);
            const countryRange = countryMax - countryMin;
            
            // Create normalized data that exaggerates fluctuations within each country's range
            const normalizedData = validData.map(d => ({
                year: d.year,
                production: d.production,
                // Normalize to 0-1 range within country, then apply power scaling
                normalizedHeight: countryRange > 0 ? 
                    Math.pow((d.production - countryMin) / countryRange, 0.4) * ridgeHeight * 0.8 + ridgeHeight * 0.2 :
                    ridgeHeight * 0.5
            }));

            // Create line generator for the production trajectory
            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(countryData.name) - d.normalizedHeight)
                .curve(d3.curveCatmullRom.alpha(0.5)); // More responsive curve

            // Create area generator for filled ridge
            const area = d3.area()
                .x(d => xScale(d.year))
                .y0(yScale(countryData.name))
                .y1(d => yScale(countryData.name) - d.normalizedHeight)
                .curve(d3.curveCatmullRom.alpha(0.5)); // More responsive curve

            // Add the filled area (ridge) with gradient fade
            const ridge = g.append("path")
                .datum(normalizedData)
                .attr("class", "ridge")
                .attr("d", area)
                .style("fill", `url(#fade-gradient-${i})`);

            // Add country label with strikethrough for non-members in 2025
            // Countries no longer in OPEC as of 2025: Qatar, Ecuador, Angola, Indonesia
            const nonMembersIn2025 = ["Qatar", "Ecuador", "Angola", "Indonesia"];
            const isNonMember = nonMembersIn2025.includes(countryData.name);
            
            const countryLabel = g.append("text")
                .attr("class", isNonMember ? "country-label-strikethrough" : "country-label")
                .attr("x", 0)
                .attr("y", yScale(countryData.name) - 10)
                .attr("dy", "0em")
                .attr("text-anchor", "start")
                .text(countryData.name);
            
            // Add strikethrough line for non-members
            if (isNonMember) {
                const bbox = countryLabel.node().getBBox();
                g.append("line")
                    .attr("x1", bbox.x)
                    .attr("x2", bbox.x + bbox.width)
                    .attr("y1", bbox.y + bbox.height/2)
                    .attr("y2", bbox.y + bbox.height/2)
                    .style("stroke", "#999")
                    .style("stroke-width", "1.5px");
            }

            // Add hover effects
            ridge.on("mousemove", function(event) {
                d3.select(this)
                    .style("fill-opacity", 0.9);

                // Get mouse position relative to the SVG
                const [mouseX] = d3.pointer(event, this);
                
                // Find the closest year based on mouse X position
                const mouseYear = xScale.invert(mouseX);
                const closestYear = Math.round(mouseYear);
                
                // Find the data point for that year
                const dataPoint = normalizedData.find(d => d.year === closestYear);
                
                if (dataPoint) {
                    const tooltip = d3.select("#tooltip");
                    tooltip.style("opacity", 1)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px")
                        .html(`
                            <strong>${countryData.name}</strong><br>
                            Year: ${dataPoint.year}<br>
                            Production: ${dataPoint.production.toFixed(1)} thousand b/d<br>
                            Trend: ${countryData.trendPercent > 0 ? "↗ Increasing" : "↘ Decreasing"} (${countryData.trendPercent.toFixed(1)}%)
                        `);
                }
            })
            .on("mouseout", function() {
                d3.select(this)
                    .style("fill-opacity", 0.6);

                d3.select("#tooltip").style("opacity", 0);
            });

            // Add baseline for each country
            g.append("line")
                .attr("x1", 0)
                .attr("x2", width)
                .attr("y1", yScale(countryData.name))
                .attr("y2", yScale(countryData.name))
                .style("stroke", "#2e343a")
                .style("stroke-width", 1.4)
                .style("opacity", 0.7);
        });

        // // Add x-axis
        // const xAxis = d3.axisBottom(xScale)
        //     .ticks(11)
        //     .tickFormat(d3.format("d"));

        // g.append("g")
        //     .attr("transform", `translate(0, ${countries.length * ridgeSpacing + 20})`)
        //     .call(xAxis);

        // // Add x-axis label
        // g.append("text")
        //     .attr("class", "axis-label")
        //     .attr("transform", `translate(${width/2}, ${countries.length * ridgeSpacing + 50})`)
        //     .attr("text-anchor", "middle")
        //     .text("Year");


    </script>
</body>
</html>
